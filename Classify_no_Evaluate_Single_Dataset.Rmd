---
title: "Classify and Evaluate - Single"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include = FALSE} 
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
rm(list = ls())
```


# Specify key use parameters

Model and datset options are:

Baron_Mouse  # 1,886 cells, 14,861 genes
Baron_Human  # 8,569 cells, 17,499 genes
Muraro       # 2,122 cells, 18,915 genes
SegerStolpe  # 2,133 cells, 22,757 genes
Xin          # 1,449 cells, 33,889 genes
Zhou         # 2,554 cells, 19,046 genes
Bo           # 516   cells, 56,924 genes
Petropoulos1 # 1,529 cells, 26,178 genes 

```{r}

# Select dataset and model

dataset_name     <- "Baron_Mouse"
model_name       <- "Baron_Mouse"

# Select preprocessing

preproc_method   <- "nopca"
preproc_method   <- "logpca"
preproc_method   <- "pca"

# Specify which models should be run
# Note that it possible that a model is not available in the modelset, in which case the instruction is simply ignored

PREDICT_SVML    <- TRUE
PREDICT_SVMR    <- TRUE
PREDICT_RF      <- TRUE
PREDICT_GBM     <- TRUE 
PREDICT_GLMNET  <- FALSE

```

# Initialise

```{r, libraries, message=FALSE}

library(readr)
library(tidyverse)
library(gridExtra)
library(caret)
library(matrixStats)

source("Code/Predict/read_model_and_data.R")
source("Code/Predict/display_results.R") 

```


```{r, preprocess options}

if (preproc_method == "pca")  {
  log_preprocess   <- FALSE
  caret_preprocess_method <- c('scale', 'center', 'pca')
} else if (preproc_method == "nopca")  {
  log_preprocess   <- FALSE
  caret_preprocess_method <- c('scale', 'center')
} else if (preproc_method == "logpca")  {
  log_preprocess   <- TRUE
  caret_preprocess_method <- c('scale', 'center', 'pca')
}

```


```{r, Initialise}

proj_path   <- file.path(".")
data_path   <- file.path(proj_path, "DataSets")
log_path    <- file.path(proj_path, "Logs")
rdata_path  <- file.path(proj_path, "rData")
config_path <- file.path(proj_path, "config")   

# Summary results will be kept here 
report_out <- data.frame()

# Information of all the runs will be gathered in the class_summaries list  
class_summaries <- list()

```


# Read the model and Data

```{r, read model and data .rData files}

ret <- read_model_and_data(rdata_path, model_name, dataset_name, preproc_method)

preproc_model   <- ret$model[["preproc_model"]]
model_svmRadial <- ret$model[["model_svmRadial"]]
model_svmLinear <- ret$model[["model_svmLinear"]]
model_rf        <- ret$model[["model_rf"]]
model_gbm       <- ret$model[["model_gbm"]]
model_glmnet    <- ret$model[["model_glmnet"]]
features_limit  <- ret$model[["features_limit"]]
PCA_Threshold   <- ret$model[["PCA_Threshold"]]
top_genes       <- ret$model[["top_genes"]]

data            <- ret$data[["data"]]
labels          <- ret$data[["labels"]]
trainRowNumbers <- ret$data[["trainRowNumbers"]]

if (log_preprocess) {
  data <- log(1 + data)
}

```


```{r}

# If there are genes missing in the data set, add columns for these genes with expession count 0
# If the number of columns becomes high, the accuracy of classification is affected 

missing_col <- setdiff(top_genes[1:features_limit], colnames(data))
newcol      <- rep.int(0,dim(data)[1])
if (length(missing_col) > 0) {
  for (i in 1:length(missing_col)) {
    data[ , missing_col[i]] <- newcol
  }
  cat(sprintf("There were %s top 1000 features missing in the data datset.\n", length(missing_col)))
} else {
  cat(sprintf("All top 1000 features were present in the data set.\n"))
}

```


# Predict and analyse the result


## Predict svmRadial

```{r, model_svmRadial, fig.width = 6}

if (PREDICT_SVMR && !is.null(model_svmRadial)) {
  
  method            <- "SVMR" 
  pp_data           <- predict(preproc_model, data)
  predicted_classes <- predict(model_svmRadial, pp_data)
  probability       <- predict(model_svmRadial, pp_data, type = "prob")
  
  ret               <- display_results(probability, class_summaries)
  class_summaries   <- ret$class_summaries
  
  ret$plot_result
}

```


## Predict svmLinear

```{r, model_svmLinear, fig.width = 6}

if (PREDICT_SVML && !is.null(model_svmLinear)) { 
  
  method            <- "SVML" 
  pp_data           <- predict(preproc_model, data)
  predicted_classes <- predict(model_svmLinear, pp_data)
  probability       <- predict(model_svmLinear, pp_data, type = "prob")
  
  ret               <- display_results(probability, class_summaries)
  class_summaries   <- ret$class_summaries
  
  ret$plot_result
}

```


## Predict Random Forest

```{r, model_rf, fig.width = 6}

if (PREDICT_RF && !is.null(model_rf)) { 
  method            <- "RF" 
  pp_data           <- predict(preproc_model, data)
  predicted_classes <- predict(model_rf, pp_data)
  probability       <- predict(model_rf, pp_data, type = "prob")
  
  ret               <- display_results(probability, class_summaries)
  class_summaries   <- ret$class_summaries
  
  ret$plot_result
}

```


## Predict GBM

```{r, model_gbm, fig.width = 5}

if (PREDICT_GBM && !is.null(model_gbm)) { 

  method            <- "GBM" 
  pp_data           <- predict(preproc_model, data)
  predicted_classes <- predict(model_gbm, pp_data)
  probability       <- predict(model_gbm, pp_data, type = "prob")
   
  ret               <- display_results(probability, class_summaries)
  class_summaries   <- ret$class_summaries
  
  ret$plot_result
}

```



## Predict GLMNET

```{r, model_glmnet, fig.width = 5}

if (PREDICT_GLMNET && !is.null(model_glmnet)) { 

  method            <- "GBM_NP" 
  predicted_classes <- predict(model_glmnet, data)
  probability       <- predict(model_glmnet, data, type = "prob")
  
  ret               <- display_results(probability, class_summaries)
  class_summaries   <- ret$class_summaries
  
  ret$plot_result
  
}

```


```{r, fig.width = 6}

for (sum in class_summaries) {
  print (sum)
}
  
```



