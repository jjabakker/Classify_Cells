---
title: "Classify and Evaluate - Single"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include = FALSE} 
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
rm(list = ls())
set.seed (1234)
```


Make sure to set the knit directory to 'project directory' (which is Testbench_Seurat')
Run command: rmarkdown::render("Caret_Predict.Rmd")

# Specify key use parameters

Model and datset options are:

"Baron_Mouse"
"Segerstolpe"
"Muraro"
"Xin"
"c_Muraro_Segerstolpe"
"c_Xin_Segerstolpe"
"Zhou"
"Bo"
"Petropoulos1"


```{r}

# Select dataset and model

dataset_name     <- "Bo"
model_name       <- "Bo"

# Select preprocessing

preproc_method   <- "nopca"
preproc_method   <- "logpca"
preproc_method   <- "pca"

# Specify which models should be run
# Note that it possible that a model is not available in the modelset, in which case the instruction is simply ignored

PREDICT_SVML     <- TRUE
PREDICT_SVMR     <- TRUE
PREDICT_RF       <- TRUE
PREDICT_GBM      <- TRUE 
PREDICT_GLMNET   <- FALSE 

```


# Initialise

```{r, libraries, message=FALSE}

library(readr)
library(tidyverse)
library(gridExtra)
library(caret)
library(matrixStats)

source("Code/Predict/read_model_and_data.R")
source("Code/Predict/predict_model_with_labels.R")

```


```{r, general initialisation}

# Set directory paths  
proj_path       <- file.path(".")
data_path       <- file.path(proj_path, "DataSets")
log_path        <- file.path(proj_path, "Logs")
rdata_path      <- file.path(proj_path, "rData")
config_path     <- file.path(proj_path, "config")

# Summary results will be kept here 
report_out      <- data.frame()

# Information of all the runs will be gathered in the class_summaries list  
class_summaries <- list()

```


```{r, preprocess options}

if (preproc_method == "pca")  {
  log_preprocess   <- FALSE
  caret_preprocess_method <- c('scale', 'center', 'pca')
} else if (preproc_method == "nopca")  {
  log_preprocess   <- FALSE
  caret_preprocess_method <- c('scale', 'center')
} else if (preproc_method == "logpca")  {
  log_preprocess   <- TRUE
  caret_preprocess_method <- c('scale', 'center', 'pca')
}

```



#  Read in the model and data

```{r, read model and data .rData files}

ret             <- read_model_and_data(rdata_path, model_name, dataset_name, preproc_method)

preproc_model   <- ret$model[["preproc_model"]]
model_svmRadial <- ret$model[["model_svmRadial"]]
model_svmLinear <- ret$model[["model_svmLinear"]]
model_rf        <- ret$model[["model_rf"]]
model_gbm       <- ret$model[["model_gbm"]]
model_glmnet    <- ret$model[["model_glmnet"]]
features_limit  <- ret$model[["features_limit"]]
PCA_Threshold   <- ret$model[["PCA_Threshold"]]
top_genes       <- ret$model[["top_genes"]]

data            <- ret$data[["data"]]
labels          <- ret$data[["labels"]]
trainRowNumbers <- ret$data[["trainRowNumbers"]]

# In case the model and data set are the same, you do not want to predict on the whole dataset, but only on the part
# that was not used for training. In that case eliminate the training records,

if (model_name == dataset_name) {
  data   <- data[-trainRowNumbers,]
  labels <- labels[-trainRowNumbers,]
  labels <- as.data.frame(labels)
}
  
if (log_preprocess) {
  data <- log(1 + data)
}

```


```{r}

# It is conceivable that features that were used to model, do not occur in the prediction dataset.
# The simple, but rough, solution is to add these genes with 0 values, so that at least prediction
# can continue. If you miss many features, it will become an issue for accuracy......

missing_col <- setdiff(top_genes[1:features_limit], colnames(data))
newcol = rep.int(0,dim(data)[1])
if (length(missing_col) > 0) {
  for (i in 1:length(missing_col)) {
    data[ , missing_col[i]] = newcol
  }
  cat(sprintf("There were %s top %d features missing in the data datset.\n", length(missing_col), features_limit))
} else {
  cat(sprintf("All top %d features were present in the data set.\n", features_limit))
}

```

# Predict and analyse the result

## Predict svmRadial

```{r, Predict_svmRadial, fig.width = 6}

if (PREDICT_SVMR && !is.null(model_svmRadial)) { 
  ret         <- predict_model_with_labels(method         = "SVMR",
                                           preproc_method = preproc_method,
                                           model          = model_svmRadial,
                                           preproc_model  = preproc_model,
                                           model_name     = model_name,
                                           dataset_name   = dataset_name,
                                           data           = data, 
                                           labels         = labels, 
                                           report_out     = report_out)
  report_out  <- ret$report_out
}

```

## Predict svmLinear

```{r, Predict_svmLinear, fig.width = 6}

if (PREDICT_SVML && !is.null(model_svmLinear)) { 
  ret         <- predict_model_with_labels(method         = "SVML",
                                           preproc_method = preproc_method,
                                           model          = model_svmLinear, 
                                           preproc_model  = preproc_model,
                                           model_name     = model_name,
                                           dataset_name   = dataset_name,
                                           data           = data, 
                                           labels         = labels, 
                                           report_out     = report_out)
  report_out <- ret$report_out
}

```


## Predict RF

```{r, Predict_RF, fig.width = 6}

if (PREDICT_RF && !is.null(model_rf)) { 
  ret         <- predict_model_with_labels(method         = "RF",
                                           preproc_method = preproc_method,
                                           model          = model_rf, 
                                           preproc_model  = preproc_model,
                                           model_name     = model_name,
                                           dataset_name   = dataset_name,
                                           data           = data, 
                                           labels         = labels, 
                                           report_out     = report_out)   
  report_out <- ret$report_out
}

```


## Predict GBM

```{r, Predict_GBM, fig.width = 6}

if (PREDICT_GBM && !is.null(model_gbm)) { 
  ret         <- predict_model_with_labels(method         = "GBM",
                                           preproc_method = preproc_method,
                                           model          = model_gbm, 
                                           preproc_model  = preproc_model,
                                           model_name     = model_name,
                                           dataset_name   = dataset_name,
                                           data           = data, 
                                           labels         = labels, 
                                           report_out     = report_out)   
  report_out <- ret$report_out
}

```

## Predict GLMN

```{r, Predict_GLMNET, fig.width = 6}

if (PREDICT_GLMNET && !is.null(model_glmnet)) { 
  ret         <- predict_model_with_labels(method         = "GLMNET",
                                           preproc_method = preproc_method,
                                           model          = model_glmnet,
                                           preproc_model  = preproc_model,
                                           model_name     = model_name,
                                           dataset_name   = dataset_name,
                                           data           = data, 
                                           labels         = labels, 
                                           report_out     = report_out)   
  report_out <- ret$report_out
}

```


# Generate the results table 

```{r, fig.width = 6}
print(class_summaries)
print(report_out)
```


```{r, fig.width = 5}
ggplot(report_out) +
  geom_point(aes(x = Accuracy, y = Confidence, col = Method)) +
  facet_wrap( ~ TestData) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_light()
```



```{r}
ro <- report_out %>%
  select(Method, TestData, medianF1, meanF1, Accuracy)

d <- unique(ro$TestData)

ro1 <- ro %>%
  filter(TestData == d[1]) %>%
  select(medianF1) 
colnames(ro1) <- "Median F1"
  
ro2 <- ro %>%
  filter(TestData == d[1]) %>%
  select(meanF1) 
colnames(ro2) <- "Mean F1"
ro1 <- cbind(ro1, ro2)

ro3 <- ro %>%
  filter(TestData == d[1]) %>%
  select(Accuracy) 
colnames(ro3) <- "Accuracy"
ro1 <- cbind(ro1, ro3)

rownames(ro1) <- unique(ro$Method)
knitr::kable(ro1, digits = 2, caption = "median F1")

ro1

```



